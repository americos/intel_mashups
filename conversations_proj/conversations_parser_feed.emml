<mashup xmlns:xsi= "http://www.w3.org/2001/XMLSchema-instance" 
 	 xsi:schemaLocation="http://www.openmashup.org/schemas/v1.0/EMML/../schemas/EMMLPrestoSpec.xsd" 
 	 xmlns="http://www.openmashup.org/schemas/v1.0/EMML" 
 	 xmlns:macro="http://www.openmashup.org/schemas/v1.0/EMMLMacro" 
 	 name = "conversations_parser_feed" >
 	 
 	 <operation name="invoke">
 	 <output name="result" type="string"></output>
 	 
 	 
 	 <!-- Input -->
 	 <input name="url" type="string" default=""></input>
 	 <input name="counter" type="number" default="1"></input>
 	 <input name="repetitive_elem" type="string" default="item"></input>
 	 <input name="limit" type="number" default="4"></input>
 	 
 	 <variables>
		
	 </variables>
 	 
 	 
 	 <script>
 	 	<![CDATA[
 	 		//OUTPUT VARIABLE FOR ALL
 	 		var my_output = "output" + counter
 	 	
  			
  			//Direct Invoke of the URL
  			var res = ' <directinvoke endpoint="' + url + '" outputvariable="'+ my_output +'"/>'
  			
			//Removing &'s  			  			
  			res = res + '<variable name="mystring" type="string"/>'
  			res = res + '<script><![CDATA['
  			res = res + 'var mystring=""; var res = new Packages.java.lang.String('+ my_output +');'
  			res = res + 'res = res.replaceAll("&" , "&amp;");'
  			res = res + 'mystring = res;' 
  			res = res + "]]xx></script>"
  			res = res + '<assign fromvariable="mystring" outputvariable="'+ my_output +'" />';
  			
  			//Applying limit
  			res = res + '<filter inputvariable="'+ my_output + '"'
  			res = res + ' filterexpr="//'+ repetitive_elem +'[position() = (1 to '+ limit +')]"'
  			res = res + ' outputvariable="' + my_output + '" />'
  			
  			//Get section with items/entries into a constructor
    		res = res + '<constructor outputvariable="' + my_output +'">';
    		res = res + '<' + my_output + '>{$' + my_output + '//*:' + repetitive_elem + '}</' + my_output + '> </constructor>';
      		
      		//Fuzzy logic to close the cdata section
      		res = new Packages.java.lang.String(res);
  			res = res.replaceAll("xx","");
  			
  			result = res;
		]]>
	</script>
 	 
 	
 	 
 	 </operation>
</mashup>
